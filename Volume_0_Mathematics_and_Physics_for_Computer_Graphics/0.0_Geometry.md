
- [点、向量和法向量](#点、向量和法向量)
- [齐次坐标系](#齐次坐标系)
- [关于点和向量的数学操作](#关于点和向量的数学操作)
- [矩阵](#矩阵)
- [矩阵的原理：第1部分](#矩阵的原理：第1部分)
- [矩阵的原理：第2部分](#矩阵的原理：第2部分)
- [点和向量的移动](#点和向量的移动)
- [以行为主还是以列为主？](#以行为主还是以列为主？)
- [矩阵操作](#矩阵操作)
- [球坐标系和三角函数](#球坐标系和三角函数)
- [正规矩阵](#正规矩阵)


# 点、向量和法向量

一般情况下，**点**是三维空间中的一个位置，**矢量**是三维空间中的方向。  
三维的点和向量是类似的，都使用以下元组符号表示：
$$V = (x,y,z)$$


![Figure 1: a point describes a position in space. A vector can be seen as a direction.](http://o9z9uibed.bkt.clouddn.com/image/20171024/172952802.png?imageslim)

---

**齐次点(homogeneous points)**，有时候为了数学上的方便，有必要添加第四个元素$$w$$，这就是**齐次点**。  
$$P_{H} = (x,y,z,w)$$

---

**法向量(Normals)** 是描述几何对象表面上的一个点的方向。
在技术上，在点$$P$$处的法向量可以被看作是与该表面相切的平面的法向量。

![Figure 2: a normal is perpendicular to the plane tangent a P.](http://o9z9uibed.bkt.clouddn.com/image/20171024/172907170.png?imageslim)

# 齐次坐标系

**笛卡尔坐标系(Cartesian coordinate system)**，是直角坐标系和斜角坐标系的统称。

相交于原点的两条数轴，构成了平面放射坐标系。如果两条数轴上的度量单位相等，则称此放射性坐标系为笛卡尔坐标系。

如果两条数轴相互垂直，则为**笛卡尔直角坐标系**，否则是**笛卡尔斜角坐标系**。

---
**左手坐标系和右手坐标系**

通常情况下不管是左手还是右手，中指都指向Z轴。

一般情况下，我们使用的都是**右手坐标系**：即X轴指向纸的右面，Y轴指向纸的上面，Z轴指向纸的外面，对应右手坐标系就是拇指是X，食指是Y，中指是Z。  
![mark](http://o9z9uibed.bkt.clouddn.com/image/20171024/203408720.png?imageslim)

# 关于点和向量的数学操作


**向量的长度**：
$$||V|| = \sqrt{V.x_V.x + V.y_V.y + V.z*V.z}$$

---

**归一化向量**：

$$\hat{V} = \frac {V} {||V||}$$

---

**点积 数量积**：一个向量在另一个向量上的投影，返回一个实数
$$A {\cdot} B = A.x  B.x + A.y  B.y + A.zB.z = ||A|| * ||B|| * cos(\theta)$$

![mark](http://o9z9uibed.bkt.clouddn.com/image/20171025/224103216.png?imageslim)

当两个向量被归一化的时候，使用**点积的反余弦值**可以得到两个向量之间的角度 $$\theta$$。  
$$\theta = cos^{-1}(\frac{A \cdot B}{||A|| * ||B||})$$

点积运算复合交换律、分配律和组合律。

---

**叉乘 矢量积**：叉乘为返回一个垂直于向量$$A$$和向量$$B$$的向量$$C$$，$$C = A \times B$$

得到的结果向量的模 $$|C| = |A| * |B| * sin(\theta)$$

将$$C$$展开为

* $$C_{X} = A_{Y}  B_{Z} - A_{Z}  B_{Y}$$
* $$C_{Y} = A_{Z}  B_{X} - A_{X}  B_{Z}$$
* $$C_{Z} = A_{X}  B_{Y} - A_{Y}  B_{X}$$

叉乘没有交换律

* $$A\times B = C$$
* $$B\times A = -C$$
* $$(1,0,0)\times (0,1,0) = (0,0,1)$$
* $$(0,1,0)\times (1,0,0) = (0,0,-1)$$

叉乘运算复合**右手定则**：向量$$C$$的方向为使用右手坐标系时向量$$A$$握拳到向量$$B$$时（握拳转动的角度不超过180°），大拇指所指的方向。

# 矩阵

一般我们使用$$m * n$$来描述一个矩阵的行和列（rows and columns），使用符号 $$M {i j}$$ 描述矩阵M中的第$$i$$行第$$j$$列的元素。

在CG中我们只要使用的是方阵，一般是$$3 3$$或者$$4 4$$。

---

**矩阵相乘**的操作是点和向量**矩阵变换**过程的核心。矩阵乘法得到的结果是另一个矩阵。

矩阵相乘的时候，第一个矩阵的列必须等于第二个矩阵的行:  
$$[M\times P] * [P\times N] = [M\times N]$$

> 矩阵乘法没有交换律。
> 但是矩阵乘法有结合律。


# 矩阵的原理：第1部分

> 教程中所讲的矩阵乘法都是**右乘**：即将矩阵写在乘号的右边，此时将向量看成是一行。\
> 但在一些OpenGL使用的3D开源库（比如glm）中是**左乘**：即将矩阵写在乘号的左边，此时将向量看成是一列。

点和向量是三个数字的序列，因此可以写成是$$1\times 3$$的矩阵。

$$P =  
\left[
\begin{array}{cc}  
x  y  z
\end{array}  
\right]$$

---

一个点乘于一个矩阵结果是一个点。

$$\left[ x y z \right] *  
\left[  
\begin{array}{cc}  
C_{00} & C_{01} & C_{02} \\
C_{10} & C_{11} & C_{12} \\
C_{20} & C_{21} & C_{22}
\end{array}  
\right]$$

---

**单位矩阵**是一个方阵，除了对角线上的系数为1，别的系数都为0。

---

**缩放矩阵Scale**是将点的坐标乘于一些实数，这样点的坐标就会产生缩放。

$$\left[  
\begin{array}{cc}  
S{x} & 0 & 0 \\
0 & S{y} & 0 \\  
0 & 0 & S_{z}
\end{array}  
\right]$$

---

**旋转矩阵Rotate**\  
将一个点或者是一个向量绕着坐标系的一个轴来旋转。

$$R_{x}(\theta) =  
\left[  
\begin{array}{cc}  
1 & 0 & 0 \\  
0 & cos(\theta) & sin(\theta) \\  
0 & -sin(\theta) & cos(\theta)
\end{array}  
\right]$$


$$R_{y}(\theta) =  
\left[  
\begin{array}{cc}  
cos(\theta & 0 & -sin(\theta) \\  
0 & 1 & 0 \\  
sin(\theta) & 0 & cos(\theta)
\end{array}  
\right]$$

$$R {z}(\theta) =  
\left[  
\begin{array}{cc}  
cos(\theta) & sin(\theta) & 0 \\  
-sin(\theta) & cos(\theta)& 0 \\  
0 & 0 &1
\end{array}  
\right]$$

**平移矩阵Translate**
必须要使用$$4\times 4$$的变换矩阵才能解决这个问题。

---

**组合矩阵**
可以将$$R_{x}$$ 和 $$R_{y}$$ 组合成一个新的旋转矩阵。  
但是要注意组合的顺序，$$R_{xy} = R_{x} * R {y}$$，这个时候就是先旋转X轴然后旋转Y轴，一起组合成一个新的旋转。

> 比如想先缩放一个点，然后旋转一个点，矩阵分别为$$S$$和$$R$$。
> 当然在左乘和右乘里面的S和R是不一样的，互为转置矩阵。
>
> * 左乘是 $$\hat{P} = [R * (S * P)]$$
> * 右乘是 $$\hat{P} = [(P * S) * R]$$
>
> 要记住矩阵相乘有结合律。

# 矩阵的原理：第2部分

**矩阵和坐标系的关系**  
矩阵的每一行表示坐标系的轴（或者是基数）。

比如旋转矩阵是这样的：  
$$R {z}(\theta) =  
\left[  
\begin{array}{cc}  
cos(\theta) & sin(\theta) & 0 \\
-sin(\theta) & cos(\theta)& 0 \\
0 & 0 &1  
\end{array}  
\right]$$

当我们使用旋转矩阵将点$$P=[1,0,0]$$ 绕z轴旋转 $$\theta$$角度的时候，$$\hat{P} = [cos(\theta),sin(\theta),0]$$

当我们使用旋转矩阵将点$$P=[0,1,0]$$ 绕z轴旋转 $$\theta$$角度的时候，$$\hat{P} = [-sin(\theta),cos(\theta),0]$$

则当我们使用旋转矩阵将点$$P=[1,1,0]$$ 绕z轴旋转 $$\theta$$角度的时候，$$\hat{P} = [cos(\theta)-sin(\theta),sin(\theta)+cos(\theta),0]$$

---

**正交矩阵**

正交矩阵使用Q来表示。正交矩阵的转置矩阵等于其逆矩阵。

* $$Q^{T} = Q^{-1}$$  
* $$QQ^{T}=I$$

正交矩阵的n个行或者列向量是n维空间的一组标准正交基。

# 点和向量的移动
**点的移动**，之前点的旋转以及点的缩放都可以直接使用$$3*3$$的矩阵来对$$1*3$$的点进行操作，但是当要对点进行移动操作时，必须使用$$4*4$$的矩阵来对$$1*4$$的点进行操作。

$$1*4$$的点记作$$[x  y  z  w]$$，一般情况下**w**为1。

乘于$$4*4$$的矩阵之后，


$$\hat{P}.x = P.x*M_{00} + P.y*M_{10} + P.z*M_{20} + M_{30}$$
$$\hat{P}.y = P.x*M_{01} + P.y*M_{11} + P.z*M_{21} + M_{31}$$
$$\hat{P}.z = P.x*M_{02} + P.y*M_{12} + P.z*M_{22} + M_{32}$$
$$\hat{P}.w = P.x*M_{03} + P.y*M_{13} + P.z*M_{23} + M_{33}$$


**齐次点**
点的`w`的存在就是为了归一化，当使用**透视变换矩阵**的时候，w会变成非1，这个时候需要对点P进行归一化，这样可以得到一个在笛卡尔坐标系中的点。


# 以行为主还是以列为主？
在之前通常把向量写成一行三列的形式：
$$P =
\left[  
\begin{array}{cc}  
x & y & z
\end{array}  
\right]$$

也可以将向量写成三行一列的形式：
$$P =
\left[  
\begin{array}{cc}  
x \\
y \\
z
\end{array}  
\right]$$

以行为主或者是以列为主模式只是一个习惯。

---

当是一行三列的时候：
$$
\left[  
\begin{array}{cc}  
x & y & z
\end{array}  
\right] * \left[  
\begin{array}{cc}  
C_{00} & C_{01} & C_{02} \\
C_{10} & C_{11} & C_{12} \\
C_{20} & C_{21} & C_{22}
\end{array}  
\right] = \left[  
\begin{array}{cc}  
x' & y' & z'
\end{array}  
\right] $$

当是三行一列的时候：
$$
\left[  
\begin{array}{cc}  
C_{00} & C_{01} & C_{02} \\
C_{10} & C_{11} & C_{12} \\
C_{20} & C_{21} & C_{22}
\end{array}  
\right] * \left[  
\begin{array}{cc}  
x \\ y \\ z
\end{array}  
\right]  = \left[  
\begin{array}{cc}  
x' \\ y' \\ z'
\end{array}  
\right]  $$

---
> 若将**左乘变成右乘**，那么要对前面的变换矩阵$$C$$做出**转置**变成$$C^{T}$$。


**变换的结合顺序**
若想对点P先使用变换矩阵T，然后绕Z轴旋转矩阵Rz，然后绕Y轴旋转矩阵Ry，得到点P'。
- 使用一行三列的时候（被称为左乘或者前乘）：
$$P' = P * T * Rz * Ry$$
- 使用三行一列的时候（被称为右乘或者后乘）：
$$P' = Ry * Rz * T * P$$

因为矩阵的乘法符合结合律。

---
行主矩阵约定使得矩阵更易读，这就是我们将其用于Scratchapixel（以及Maya，DirectX）的原因。然而，一些3D API（如OpenGL）使用列主要约定。



# 矩阵操作
**矩阵的转置$$M^{T}$$**

矩阵的转置$$M^{T}$$与矩阵$$M$$与主对角线对称，即$$M^{T}_{ij} = M_{ji}$$。

---
**逆矩阵$$M^{-1}$$**

$$M*M^{-1} = I$$
> 逆矩阵在3D变换中是一个很重要的概念，可以使用矩阵来转换点或者是向量，但是将变换之后的点或者向量恢复到变换之前的位置就需要逆矩阵的转换。

> 正交矩阵： $$Q^{T} = Q^{-1}$$

# 球坐标系和三角函数

在线性代数中可以使用球面坐标来表示向量。

**三角函数**

- 角度值 $$\theta_{radians}$$
- 弧度制 $$\theta_{degrees}$$
- 转换关系 $$\theta_{radians} = /pi / 180 * \theta_{degrees} $$

- $$sin(\theta) = P_{x}$$
- $$cos(\theta) = P_{y}$$
- $$tan(\theta) = P_{y}/P_{x}$$

- $$asin(P_{x}) = \theta$$
- $$acos(P_{y}) = \theta$$
- $$atan2(P_{y},P_{x}) = \theta$$

---
**用球面坐标表示向量**
用**仰角**和**方位角**两个角来表示向量。


$$(\theta,\phi)$$

$$\theta \in [0:\pi]$$

$$\phi \in [0:2\pi]$$

如下图所示：

![mark](http://o9z9uibed.bkt.clouddn.com/image/20171107/152809347.png?imageslim)

---

**Z轴是向上的轴**

在数学和物理中表示向量的惯例是将向上的轴命名为Z轴。和上图一样，使用的是左手坐标系。

已知点P的坐标为：
$$P = [x,y,z,w]$$

坐标系的转换是一件相当麻烦的事情，有的时候需要一个转换矩阵：
$$T =  
\left[  
\begin{array}{cc}  
1 & 0 & 0 & 0 \\
0 & 0 & 1 & 0 \\
0 & 1 & 0 & 0 \\
0 & 0 & 0 & 1  
\end{array}  
\right]
$$

那么 $$P*T = [x,z,y,w]$$

这就是坐标系的转换。

---
**将笛卡尔坐标转换为球坐标**
> $$[Vx,Vy,Vz]->(\theta,\phi)$$

$$\theta = acos(Vz);  $$

$$\phi = atan2(Vy, Vx); $$

---

**球坐标到笛卡尔坐标**

> $$(\theta,\phi)->[Vx,Vy,Vz]$$

$$Vx=cos(\phi)sin(\theta)$$

$$Vy=sin(\phi)sin(\theta)$$

$$Vz=cos(\theta)$$

# 正规矩阵
**法线**是垂直与点P切平面的矢量，如果知道了点P表面的切线T和双切线B，那么就可以使用叉乘计算出点P的法线N。

因为法线没有其次坐标，那么平移不影响到法向量，但是缩放和旋转操作就可能会影响到法线。

**正规矩阵**对原法向量进行了线性代数操作移除了对法向量的错误缩放效果。

在下图中，法向量通过`Scale`变换之后，与平面并不垂直了。

![](http://o9z9uibed.bkt.clouddn.com/image/20170809/161553425.png?imageslim)

现在求取变换使得`N`经过`model`变换之后依然垂直与平面。

则$$ N' = N * M^{-1 T}$$

证明见[链接](https://whpointz.coding.me/2017/08/09/%E8%B0%88%E8%B0%88%E6%AD%A3%E8%A7%84%E7%9F%A9%E9%98%B5/)
